# url rewrite script for weitoutiao
# for nginx
location = /stream/view {
    set $dist '0';
    set $biz 'none';
    set $stream_id '0';
    set $ack_code '0';
    set $validate '0';
    if ( $query_string ~ stream_id=(\d+)(.*)_ack=(\w+) ) {
        set $stream_id $1;
        set $ack_code  $3;
    }

    if ( $query_string ~ biz=(\w+) ) {
        set $biz $1;
    }

    if ( $query_string ~ acm=(\w+)-(\d+)-(\d+)-(\w+) ) {
        set $dist $2;
        set $validate "$1-$3-$4:$biz-$stream_id-$ack_code";
    }

    if ( $validate !~ ^([^:]+):\1$ ) {
        rewrite ^ /index.php last;
    }

    #-----------------------------------------
    # none biz re-define
    set $user_agent '0';
    set $q_string '0';
    if ( $biz = none ) {
        set $user_agent $http_user_agent;
        set $q_string $query_string;
    }

    if ( $q_string ~ site=m&? ) {
        set $biz 'mobile';
    }

    if ( $user_agent ~* (phone|mobile|tablet|android|iphone|blackberry|symbian|nokia|palmos|j2me) ) {
        set $biz 'mobile';
    }

    if ( $biz = none ) {
        set $biz 'pc';
    }

    #-------------------------------------------
    #static interception: check and rewrite to the static file if it exists
    set $static_file stream/view/$biz/$dist/$stream_id-$ack_code.html;
    if ( -f $document_root/cache/$static_file ) {
        rewrite ^ /cache/$static_file last;
    }

    rewrite ^ /index.php last;
}

location = /api/stream/view {
    set $dist '0';
    set $stream_id '0';
    set $ack_code  '0';
    set $validate  '0';
    if ( $query_string ~ stream_id=(\d+)(.*)_ack=(\w+) ) {
        set $stream_id $1;
        set $ack_code  $3;
    }

    if ( $query_string ~ acm=(\w+)-(\d+)-(\d+)-(\w+) ) {
        set $dist $2;
        set $validate "$3-$4:$stream_id-$ack_code";
    }

    if ( $validate !~ ^([^:]+):\1$ ) {
        rewrite ^ /index.php last;
    }

    set $static_file stream/content/$dist/$stream_id-$ack_code.json;
    # return "http://localhost?static_file=$static_file";
    if ( -f $document_root/cache/$static_file ) {
        rewrite ^ /cache/$static_file last;
    }

    rewrite ^ /index.php last;
}

location ^~ /script/ {
    # @Note: if any rewrite rules has been apply over the current location
    # and the document_uri will be unsafe(will be changed)
    set $script_file '0';
    if ( $document_uri ~ ^([\w/-]+)/(\w)\w*$ ) {
        set $script_file "$1/$2.js";
    }

    # return "http://localhost?script_file=/cache$script_file";
    if ( -f $document_root/cache$script_file ) {
        rewrite ^ /cache$script_file last;
    }

    rewrite ^ /index.php last;
}

# added at 2016/06/02
# 1, make sure the request will redirect to the quiz.xxx host
# 2, static interception except 'MicroMessenger' finded at user agent
location ^~ /quiz/ {
    # change your safe domain here
    set $safe_host_1 'quiz.app.org';
    set $safe_host_2 'share.app.org';
    set $tmp_host $http_host;

    # only redirect for wechat
    if ( $http_user_agent !~ MicroMessenger ) {
        set $tmp_host $safe_host_1;
    }

    # no redirect for embed quiz
    if ( $request_uri ~ ^/quiz/embed/ ) {
        set $tmp_host $safe_host_1;
    }

    set $new_host $safe_host_1;
    if ( $query_string ~ quiz_id=\d*[02468]& ) {
        set $new_host $safe_host_2;
    }

    #return "http://localhost?new_host=$new_host";
    set $validate "$safe_host_1:$safe_host_2:$tmp_host";
    if ( $validate !~ ^([^:]+):([^:]+):(\1|\2)$ ) {
        rewrite (.*) http://$new_host$1 redirect;
    }

    # ---------------------------------------------
    # simple version
    # set $host_pre '0';
    # set $host_val '0';
    # if ( $http_host ~ ^(\w+)\.(.*) ) {
    #     set $host_pre $1;
    #     set $host_val $2;
    # }

    # if ( $http_user_agent !~ MicroMessenger ) {
    #     set $host_pre quiz;
    # }

    # if ( $request_uri ~ ^/quiz/embed ) {
    #     set $tmp_host quiz;
    # }

    # if ( $host_pre != quiz ) {
    #     rewrite (.*) http://quiz.$host_val$1 redirect;
    # }

    # ---------------------------------------------------------
    # static interception
    set $static_file $document_uri.html;
    if ( $query_string ~ quiz_id=(\d+) ) {
        set $static_file $document_uri/$1.html;
    }

    # return "http://localhost?static_file=/cache$static_file";
    if ( -f $document_root/cache$static_file ) {
        rewrite ^ /cache$static_file last;
    }

    rewrite ^ /index.php last;
}


# common url rewrite
set $match 1;
if ( $request_uri ~ ^/(script|quiz|stream/view|api/stream/view) ) {
    set $match 0;
}

# cache flush interception
if ( $query_string ~ __flush_mode__=1&__flush_key__=\w+ ) {
    set $match 1;
}

if ( $match ) {
    rewrite ^[\w/-]+$ /index.php last;
}
